---
- name: Terminate ALL EC2 to stop charging me
  community.aws.ec2_instance:
    state: 'absent'
    filters:
      instance-state-name: running
    region: "{{AWS_REGION}}"
- name: Gather information of VPC
  ec2_vpc_net_info:
    filters:
      "tag:Name": "{{AWS_PREFIX}}_VPC"
    region: "{{AWS_REGION}}"
  register: vpc_return
- name: Remove security group
  ec2_group:
    name: "{{AWS_PREFIX}}_SECGROUP"
    state: 'absent'
    tags:
      Name: "{{AWS_PREFIX}}_SECGROUP"
    region: "{{AWS_REGION}}"
- name: Remove the routing table
  ec2_vpc_route_table:
    state: 'absent'
    region: "{{AWS_REGION}}"
    vpc_id: "{{vpc_return.vpcs[0].id}}"
    tags:
      Name: "{{AWS_PREFIX}}_RTBL"
- name: Remove the internet gateway
  ec2_vpc_igw:
    state: 'absent'
    vpc_id: "{{vpc_return.vpcs[0].id}}"
    region: "{{AWS_REGION}}"
- name: Remove the Subnet
  ec2_vpc_subnet:
    state: 'absent'
    vpc_id: "{{vpc_return.vpcs[0].id}}"
    cidr: 10.42.10.0/24
    region: "{{AWS_REGION}}"
    wait: yes
- name: Remove the VPC
  ec2_vpc_net:
    state: 'absent'
    cidr_block: 10.42.0.0/16
    name: "{{AWS_PREFIX}}_VPC"
    region: "{{AWS_REGION}}"

